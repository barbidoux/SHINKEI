<script lang="ts">
    import type { StoryBeat, BeatResponse } from "$lib/types";
    import AIThoughtsPanel from "./AIThoughtsPanel.svelte";

    export let beat: StoryBeat;
    export let storyId: string;
    export let onModify: (beat: StoryBeat) => void;
    export let onDelete: (beatId: string) => void;
    export let onUpdate: () => void;

    let isExpanded = true;

    function toggleExpanded() {
        isExpanded = !isExpanded;
    }
</script>

<div
    class="relative rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 shadow-sm transition-shadow hover:shadow-md"
>
    <div class="px-6 py-5">
        <!-- Header with drag handle and controls -->
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
                <!-- Drag Handle -->
                <button
                    class="cursor-grab active:cursor-grabbing text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 drag-handle"
                    aria-label="Drag to reorder"
                    tabindex="-1"
                >
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                    </svg>
                </button>

                <!-- Beat Type Badge -->
                <span
                    class="inline-flex items-center rounded-md bg-gray-50 dark:bg-gray-700 px-2 py-1 text-xs font-medium text-gray-600 dark:text-gray-300 ring-1 ring-inset ring-gray-500/10 dark:ring-gray-600"
                >
                    {beat.type}
                </span>

                <!-- Beat Number -->
                <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                    Beat #{beat.order_index}
                </span>

                <!-- Time Label -->
                {#if beat.local_time_label}
                    <span
                        class="inline-flex items-center rounded-md bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 text-xs font-medium text-indigo-700 dark:text-indigo-300 ring-1 ring-inset ring-indigo-600/20 dark:ring-indigo-500/30"
                    >
                        {beat.local_time_label}
                    </span>
                {/if}

                <!-- Generated By Badge -->
                {#if beat.generated_by === "ai"}
                    <span
                        class="inline-flex items-center rounded-md bg-purple-50 dark:bg-purple-900/30 px-2 py-1 text-xs font-medium text-purple-700 dark:text-purple-300 ring-1 ring-inset ring-purple-600/20 dark:ring-purple-500/30"
                    >
                        AI Generated
                    </span>
                {:else if beat.generated_by === "collaborative"}
                    <span
                        class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-900/30 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300 ring-1 ring-inset ring-blue-600/20 dark:ring-blue-500/30"
                    >
                        Collaborative
                    </span>
                {:else}
                    <span
                        class="inline-flex items-center rounded-md bg-green-50 dark:bg-green-900/30 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-300 ring-1 ring-inset ring-green-600/20 dark:ring-green-500/30"
                    >
                        Manual
                    </span>
                {/if}

                <!-- Expand/Collapse Button -->
                <button
                    on:click={toggleExpanded}
                    class="text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 ml-2"
                    aria-label={isExpanded ? "Collapse" : "Expand"}
                >
                    {isExpanded ? "â–¼" : "â–¶"}
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center gap-2">
                <button
                    on:click={() => onModify(beat)}
                    class="text-xs text-purple-600 dark:text-purple-400 hover:text-purple-500 dark:hover:text-purple-300 font-medium"
                >
                    ðŸ¤– Modify with AI
                </button>
                <a
                    href="/stories/{storyId}/beats/{beat.id}/edit"
                    class="text-xs text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 dark:hover:text-indigo-300"
                >
                    Edit
                </a>
                <button
                    on:click={() => onDelete(beat.id)}
                    class="text-xs text-red-600 dark:text-red-400 hover:text-red-500 dark:hover:text-red-300"
                >
                    Delete
                </button>
            </div>
        </div>

        <!-- Summary (always visible when collapsed) -->
        {#if beat.summary}
            <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                {beat.summary}
            </p>
        {/if}

        <!-- Content (collapsible) -->
        {#if isExpanded}
            <p class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap">
                {beat.content}
            </p>
        {/if}

        <!-- World Event Link -->
        {#if beat.world_event_id}
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400">
                    Linked to World Event ID: {beat.world_event_id}
                </p>
            </div>
        {/if}
    </div>

    <!-- AI Thoughts Panel -->
    {#if isExpanded && (beat.generated_by === "ai" || beat.generation_reasoning)}
        <div class="px-6 pb-5">
            <AIThoughtsPanel
                beat={beat as BeatResponse}
                onUpdate={onUpdate}
            />
        </div>
    {/if}
</div>

<style>
    .cursor-grab:active {
        cursor: grabbing;
    }

    .drag-handle {
        touch-action: none;
    }
</style>
